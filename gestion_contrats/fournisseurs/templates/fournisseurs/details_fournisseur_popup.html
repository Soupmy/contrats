<div id="detailsContratPopup" class="popup details-popup" style="display: none;">
    <div class="popup-content">
        <span class="close" onclick="closeDetailsPopup()">&times;</span>
        <h2>Détails du Contrat</h2>
        <div class="popup-body">
            <div class="form-popup">
                <div class="form-grid" id="detailsContent">  
                    <!-- Le contenu sera généré dynamiquement par JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function openDetailsPopup(contratId) {
    // Afficher un message de chargement
    document.getElementById('detailsContent').innerHTML = '<div class="loading">Chargement...</div>';
    document.getElementById('detailsContratPopup').style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    fetch(`/contrats/details/${contratId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur réseau: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const contentContainer = document.getElementById('detailsContent');
            contentContainer.innerHTML = ''; // Réinitialise le contenu

            // Forcer les données à s'afficher même si null ou undefined
            for (const [field, value] of Object.entries(data)) {
                const formGroup = document.createElement('div');
                formGroup.classList.add('form-group');

                const label = document.createElement('label');
                label.textContent = field;

                const input = document.createElement('input');
                input.type = 'text';
                // Correction de l'affichage des valeurs null/undefined
                input.value = (value !== null && value !== undefined) ? value : '';
                input.readOnly = true;
                input.classList.add('readonly-field');

                formGroup.appendChild(label);
                formGroup.appendChild(input);
                contentContainer.appendChild(formGroup);
            }
        })
        .catch(error => {
            console.error("Erreur détails:", error);
            document.getElementById('detailsContent').innerHTML = 
                '<div class="error-message">Erreur lors du chargement des détails</div>';
        });
}

function closeDetailsPopup() {
    document.getElementById('detailsContratPopup').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Fermeture avec le bouton X
document.addEventListener('DOMContentLoaded', function() {
    const closeBtn = document.querySelector('#detailsContratPopup .close');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeDetailsPopup);
    }
});

// Fermeture en cliquant en dehors du popup
window.addEventListener('click', function(event) {
    if (event.target == document.getElementById('detailsContratPopup')) {
        closeDetailsPopup();
    }
});
</script>