{% load custom_filters %}

<div id="editPopup" class="popup" style="display: none;">
    <div class="popup-content">
        <span class="close" onclick="closeEditPopup()">&times;</span>
        <h2>Modifier le Fournisseur</h2>
        <div class="popup-body">
            <form id="editForm" method="post" class="form-popup">
                {% csrf_token %}
                <input type="hidden" name="_method" value="PUT">
            
                <div class="form-grid" id="editFormContent">
                    {% for row in field_values|batch:2 %}
                        <div class="form-row">
                            {% for field, value in row %}
                                <div class="form-group">
                                    <label for="{{ field }}">
                                        {{ field }}
                                        {% if field in required_fields %}
                                            <span style="color: red; margin-left: 4px;">*</span>
                                        {% endif %}
                                    </label>
                                    <input type="text" 
                                           name="{{ field }}"
                                           value="{{ value }}"
                                           class="editable-field">
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            
                <button type="submit" class="btn-ajouter btn-primary">Enregistrer</button>
            </form>            
        </div>        
    </div>
</div>


<script>
    function openEditPopup(fournisseurId) {
        fetch(`/fournisseurs/modifier/${fournisseurId}/`)
            .then(response => response.text())
            .then(data => {
                document.getElementById('editFormContent').innerHTML = data; // Injecte les champs ici
                document.getElementById('editForm').action = `/fournisseurs/modifier/${fournisseurId}/`;
                document.getElementById('editPopup').style.display = 'flex';
            });
    }

    function closeEditPopup() {
        document.getElementById('editPopup').style.display = 'none';
    }

    document.getElementById('editForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const formData = new FormData(this);

        fetch(this.action, {
            method: 'POST', // Django interprétera PUT via _method
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload(); // Recharger la page après modification
            } else {
                alert("Erreur lors de la modification !");
            }
        });
    });
    document.querySelectorAll('.close-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        closePopup(btn.closest('.popup').id);
    });
    });
</script>
